// Prisma Schema for KOM (King of the Market) Backend
// Car Marketplace for Bahrain

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  SUPER_ADMIN
  ADMIN
  USER_INDIVIDUAL
  USER_SHOWROOM
}

enum ListingType {
  CAR
  PLATE
  PART
  MOTORCYCLE
}

enum PlateType {
  PRIVATE
  TRANSPORT
  MOTORCYCLE
}

enum ListingStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
  SOLD
  EXPIRED
}

enum Currency {
  BHD
}

enum ContactPreference {
  IN_APP_CHAT
  WHATSAPP
  CALL
}

enum Transmission {
  AUTO
  MANUAL
}

enum FuelType {
  PETROL
  DIESEL
  ELECTRIC
  HYBRID
  OTHER
}

enum CarCondition {
  NEW
  USED
}

enum PartCondition {
  NEW
  USED
  REFURBISHED
}

enum MediaType {
  IMAGE
  VIDEO
}

enum StorageProvider {
  S3
  R2
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum NotificationType {
  LISTING_APPROVED
  LISTING_REJECTED
  LISTING_SUBMITTED
  PAYMENT_RECEIVED
  ACCOUNT_BANNED
  ACCOUNT_UNBANNED
  STORY_APPROVED
  STORY_REJECTED
  SYSTEM
}

enum ReportStatus {
  OPEN
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ReportType {
  LISTING
  COMPLAINT
}

enum MerchantType {
  CAR_SHOWROOM
  GARAGE
  OTHER
}

enum StoryStatus {
  PENDING
  ACTIVE
  REJECTED
  EXPIRED
}

enum CommentStatus {
  PENDING
  APPROVED
  REJECTED
}

// ==================== MODELS ====================

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  phone                 String?   @unique
  passwordHash          String?
  role                  UserRole  @default(USER_INDIVIDUAL)
  isActive              Boolean   @default(true)
  isBanned              Boolean   @default(false)
  bannedReason          String?
  bannedAt              DateTime?
  resetPasswordToken    String?   @unique
  resetPasswordExpiry   DateTime?
  lastLoginAt           DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  individualProfile IndividualProfile?
  showroomProfile   ShowroomProfile?
  listings          Listing[]
  stories           Story[]
  storyLikes        StoryLike[]
  storyComments     StoryComment[]
  notifications     Notification[]
  reports           Report[]           @relation("ReporterReports")
  adminPermission   AdminPermission?
  auditLogs         AuditLog[]
  deviceTokens      DeviceToken[]
  refreshTokens     RefreshToken[]
  favorites         Favorite[]
  chatThreadsA      ChatThread[]       @relation("ChatUserA")
  chatThreadsB      ChatThread[]       @relation("ChatUserB")
  chatMessages      ChatMessage[]      @relation("ChatMessageSender")

  @@index([email])
  @@index([phone])
  @@index([role])
  @@index([isActive, isBanned])
  @@index([resetPasswordToken])
}

model IndividualProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  fullName    String
  governorate String?
  city        String?
  avatarUrl   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ShowroomProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  showroomName  String
  crNumber      String?  // Commercial Registration Number
  merchantType  MerchantType? @default(CAR_SHOWROOM)
  description   String?
  governorate   String?
  city          String?
  address       String?
  logoUrl       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactPhones ShowroomContactPhone[]
}

model ShowroomContactPhone {
  id              String   @id @default(uuid())
  showroomId      String
  phone           String
  label           String?  // e.g., "Main", "Sales", "WhatsApp"
  isPrimary       Boolean  @default(false)
  createdAt       DateTime @default(now())

  // Relations
  showroom ShowroomProfile @relation(fields: [showroomId], references: [id], onDelete: Cascade)

  @@index([showroomId])
}

model Listing {
  id                   String            @id @default(uuid())
  ownerId              String
  ownerType            UserRole          // INDIVIDUAL or SHOWROOM (inferred from user role)
  type                 ListingType
  status               ListingStatus     @default(DRAFT)
  title                String
  description          String?
  price                Decimal           @db.Decimal(12, 3)
  currency             Currency          @default(BHD)
  locationGovernorate  String?
  locationArea         String?
  contactPreference    ContactPreference @default(CALL)
  viewsCount           Int               @default(0)
  favoritesCount       Int               @default(0)
  postedAt             DateTime?
  approvedAt           DateTime?
  expiresAt            DateTime?
  rejectedAt           DateTime?
  rejectionReason      String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  // Relations
  owner               User                 @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  carDetails          CarDetails?
  motorcycleDetails   MotorcycleDetails?
  plateDetails        PlateDetails?
  partDetails         PartDetails?
  media               Media[]
  paymentTransactions PaymentTransaction[]
  reports             Report[]
  favorites           Favorite[]
  chatThreads         ChatThread[]

  @@index([ownerId])
  @@index([type])
  @@index([status])
  @@index([price])
  @@index([createdAt])
  @@index([status, type])
  @@index([status, createdAt])
}

model ChatThread {
  id                 String      @id @default(uuid())
  listingId          String
  userAId            String
  userBId            String
  lastMessageText    String?
  lastMessageAt      DateTime?
  lastMessageSenderId String?
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  listing   Listing   @relation(fields: [listingId], references: [id], onDelete: Cascade)
  userA     User      @relation("ChatUserA", fields: [userAId], references: [id], onDelete: Cascade)
  userB     User      @relation("ChatUserB", fields: [userBId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@unique([listingId, userAId, userBId])
  @@index([listingId])
  @@index([userAId])
  @@index([userBId])
}

model ChatMessage {
  id        String   @id @default(uuid())
  threadId  String
  senderId  String
  text      String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User       @relation("ChatMessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([threadId, createdAt])
  @@index([senderId])
}

model CarDetails {
  id           String       @id @default(uuid())
  listingId    String       @unique
  make         String
  model        String
  year         Int
  trim         String?
  mileageKm    Int?
  transmission Transmission @default(AUTO)
  fuel         FuelType     @default(PETROL)
  condition    CarCondition @default(USED)
  color        String?
  vin          String?
  bodyType     String?
  engineSize   String?
  specs        Json?        // Additional specs as JSON
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([make])
  @@index([model])
  @@index([year])
  @@index([make, model])
}

model MotorcycleDetails {
  id           String       @id @default(uuid())
  listingId    String       @unique
  make         String
  model        String
  year         Int
  mileageKm    Int?
  transmission Transmission
  condition    CarCondition
  color        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([make])
  @@index([model])
  @@index([year])
  @@index([make, model])
}

model PlateDetails {
  id            String   @id @default(uuid())
  listingId     String   @unique
  plateNumber   String
  plateCategory String   // e.g., "Private", "Special", "VIP"
  plateType     PlateType?
  plateCode     String?  // Letter code
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([plateNumber])
  @@index([plateCategory])
}

model PartDetails {
  id                     String        @id @default(uuid())
  listingId              String        @unique
  partCategory           String        // e.g., "Engine", "Body", "Interior", "Electronics"
  partName               String?
  compatibleCarMake      String?
  compatibleCarModel     String?
  compatibleYearFrom     Int?
  compatibleYearTo       Int?
  condition              PartCondition @default(USED)
  partNumber             String?       // OEM or aftermarket part number
  brand                  String?
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([partCategory])
  @@index([compatibleCarMake])
}

model Media {
  id              String          @id @default(uuid())
  listingId       String
  type            MediaType
  storageProvider StorageProvider @default(S3)
  objectKey       String
  url             String
  thumbnailUrl    String?
  width           Int?
  height          Int?
  duration        Int?            // For videos, in seconds
  fileSize        Int?            // In bytes
  mimeType        String?
  sortOrder       Int             @default(0)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([listingId, sortOrder])
}

model PaymentTransaction {
  id          String        @id @default(uuid())
  listingId   String
  amount      Decimal       @db.Decimal(10, 3)
  currency    Currency      @default(BHD)
  status      PaymentStatus @default(PENDING)
  provider    String?       // e.g., "benefit", "credimax", "manual"
  providerRef String?       // External reference from payment provider
  metadata    Json?         // Additional payment metadata
  paidAt      DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@index([listingId])
  @@index([status])
  @@index([providerRef])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  metadata  Json?            // Additional data (e.g., listingId, reason)
  isRead    Boolean          @default(false)
  readAt    DateTime?
  createdAt DateTime         @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
}

model Report {
  id         String       @id @default(uuid())
  reporterId String
  listingId  String?
  type       ReportType   @default(LISTING)
  reason     String
  details    String?
  status     ReportStatus @default(OPEN)
  resolvedBy String?
  resolvedAt DateTime?
  resolution String?
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt

  // Relations
  reporter User    @relation("ReporterReports", fields: [reporterId], references: [id], onDelete: Cascade)
  listing  Listing? @relation(fields: [listingId], references: [id], onDelete: SetNull)

  @@index([reporterId])
  @@index([listingId])
  @@index([status])
  @@index([type])
}

model AdminPermission {
  id                String   @id @default(uuid())
  userId            String   @unique
  canReviewListings Boolean  @default(true)
  canManageUsers    Boolean  @default(false)
  canViewReports    Boolean  @default(true)
  canManageAdmins   Boolean  @default(false)
  canManageSettings Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String
  action     String   // e.g., "LISTING_APPROVED", "USER_BANNED", "ADMIN_CREATED"
  entityType String   // e.g., "Listing", "User", "AdminPermission"
  entityId   String
  before     Json?    // State before action
  after      Json?    // State after action
  metadata   Json?    // Additional context
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  // Relations
  actor User @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([action])
  @@index([createdAt])
}

model DeviceToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  platform  String   // "ios" or "android"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  isRevoked Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String
  listingId String
  createdAt DateTime @default(now())

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  listing Listing @relation(fields: [listingId], references: [id], onDelete: Cascade)

  @@unique([userId, listingId])
  @@index([userId])
  @@index([listingId])
  @@index([createdAt])
}

model Story {
  id              String      @id @default(uuid())
  userId          String
  mediaUrl        String
  mediaType       MediaType
  duration        Int?        // in seconds
  status          StoryStatus @default(PENDING)
  viewsCount      Int         @default(0)
  postedAt        DateTime?
  expiresAt       DateTime?
  rejectionReason String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  likesCount      Int         @default(0)
  commentsCount   Int         @default(0)

  // Relations
  user      User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  likes     StoryLike[]
  comments  StoryComment[]

  @@index([userId])
  @@index([status])
  @@index([expiresAt])
}

model StoryLike {
  id        String   @id @default(uuid())
  storyId   String
  userId    String
  createdAt DateTime @default(now())

  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([storyId, userId])
  @@index([storyId])
  @@index([userId])
}

model StoryComment {
  id        String   @id @default(uuid())
  storyId   String
  userId    String
  text      String
  status    CommentStatus @default(APPROVED)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  story     Story    @relation(fields: [storyId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([storyId])
  @@index([userId])
  @@index([createdAt])
  @@index([status])
}


model AdminVideo {
  id           String   @id @default(uuid())
  title        String?
  videoUrl     String
  thumbnailUrl String?
  description  String?
  viewsCount   Int      @default(0)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([isActive])
  @@index([createdAt])
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  type      String   @default("string") // "string", "number", "boolean", "json"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}
